//     Underscore.js 1.3.3
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore is freely distributable under the MIT license.
//     Portions of Underscore are inspired or borrowed from Prototype,
//     Oliver Steele's Functional, and John Resig's Micro-Templating.
//     For all details and documentation:
//     http://documentcloud.github.com/underscore
(function(){function C(e,t,n){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e._chain&&(e=e._wrapped),t._chain&&(t=t._wrapped);if(e.isEqual&&S.isFunction(e.isEqual))return e.isEqual(t);if(t.isEqual&&S.isFunction(t.isEqual))return t.isEqual(e);var r=a.call(e);if(r!=a.call(t))return!1;switch(r){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var i=n.length;while(i--)if(n[i]==e)return!0;n.push(e);var s=0,o=!0;if(r=="[object Array]"){s=e.length,o=s==t.length;if(o)while(s--)if(!(o=s in e==s in t&&C(e[s],t[s],n)))break}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(var u in e)if(S.has(e,u)){s++;if(!(o=S.has(t,u)&&C(e[u],t[u],n)))break}if(o){for(u in t)if(S.has(t,u)&&!(s--))break;o=!s}}return n.pop(),o}var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.slice,u=r.unshift,a=i.toString,f=i.hasOwnProperty,l=r.forEach,c=r.map,h=r.reduce,p=r.reduceRight,d=r.filter,v=r.every,m=r.some,g=r.indexOf,y=r.lastIndexOf,b=Array.isArray,w=Object.keys,E=s.bind,S=function(e){return new P(e)};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=S),exports._=S):e._=S,S.VERSION="1.3.3";var x=S.each=S.forEach=function(e,t,r){if(e==null)return;if(l&&e.forEach===l)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(r,e[i],i,e)===n)return}else for(var o in e)if(S.has(e,o)&&t.call(r,e[o],o,e)===n)return};S.map=S.collect=function(e,t,n){var r=[];return e==null?r:c&&e.map===c?e.map(t,n):(x(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),e.length===+e.length&&(r.length=e.length),r)},S.reduce=S.foldl=S.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(h&&e.reduce===h)return r&&(t=S.bind(t,r)),i?e.reduce(t,n):e.reduce(t);x(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},S.reduceRight=S.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduceRight===p)return r&&(t=S.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=S.toArray(e).reverse();return r&&!i&&(t=S.bind(t,r)),i?S.reduce(s,t,n,r):S.reduce(s,t)},S.find=S.detect=function(e,t,n){var r;return T(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},S.filter=S.select=function(e,t,n){var r=[];return e==null?r:d&&e.filter===d?e.filter(t,n):(x(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},S.reject=function(e,t,n){var r=[];return e==null?r:(x(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r)},S.every=S.all=function(e,t,r){var i=!0;return e==null?i:v&&e.every===v?e.every(t,r):(x(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var T=S.some=S.any=function(e,t,r){t||(t=S.identity);var i=!1;return e==null?i:m&&e.some===m?e.some(t,r):(x(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};S.include=S.contains=function(e,t){var n=!1;return e==null?n:g&&e.indexOf===g?e.indexOf(t)!=-1:(n=T(e,function(e){return e===t}),n)},S.invoke=function(e,t){var n=o.call(arguments,2);return S.map(e,function(e){return(S.isFunction(t)?t||e:e[t]).apply(e,n)})},S.pluck=function(e,t){return S.map(e,function(e){return e[t]})},S.max=function(e,t,n){if(!t&&S.isArray(e)&&e[0]===+e[0])return Math.max.apply(Math,e);if(!t&&S.isEmpty(e))return-Infinity;var r={computed:-Infinity};return x(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},S.min=function(e,t,n){if(!t&&S.isArray(e)&&e[0]===+e[0])return Math.min.apply(Math,e);if(!t&&S.isEmpty(e))return Infinity;var r={computed:Infinity};return x(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},S.shuffle=function(e){var t=[],n;return x(e,function(e,r,i){n=Math.floor(Math.random()*(r+1)),t[r]=t[n],t[n]=e}),t},S.sortBy=function(e,t,n){var r=S.isFunction(t)?t:function(e){return e[t]};return S.pluck(S.map(e,function(e,t,i){return{value:e,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n===void 0?1:r===void 0?-1:n<r?-1:n>r?1:0}),"value")},S.groupBy=function(e,t){var n={},r=S.isFunction(t)?t:function(e){return e[t]};return x(e,function(e,t){var i=r(e,t);(n[i]||(n[i]=[])).push(e)}),n},S.sortedIndex=function(e,t,n){n||(n=S.identity);var r=0,i=e.length;while(r<i){var s=r+i>>1;n(e[s])<n(t)?r=s+1:i=s}return r},S.toArray=function(e){return e?S.isArray(e)?o.call(e):S.isArguments(e)?o.call(e):e.toArray&&S.isFunction(e.toArray)?e.toArray():S.values(e):[]},S.size=function(e){return S.isArray(e)?e.length:S.keys(e).length},S.first=S.head=S.take=function(e,t,n){return t!=null&&!n?o.call(e,0,t):e[0]},S.initial=function(e,t,n){return o.call(e,0,e.length-(t==null||n?1:t))},S.last=function(e,t,n){return t!=null&&!n?o.call(e,Math.max(e.length-t,0)):e[e.length-1]},S.rest=S.tail=function(e,t,n){return o.call(e,t==null||n?1:t)},S.compact=function(e){return S.filter(e,function(e){return!!e})},S.flatten=function(e,t){return S.reduce(e,function(e,n){return S.isArray(n)?e.concat(t?n:S.flatten(n)):(e[e.length]=n,e)},[])},S.without=function(e){return S.difference(e,o.call(arguments,1))},S.uniq=S.unique=function(e,t,n){var r=n?S.map(e,n):e,i=[];return e.length<3&&(t=!0),S.reduce(r,function(n,r,s){if(t?S.last(n)!==r||!n.length:!S.include(n,r))n.push(r),i.push(e[s]);return n},[]),i},S.union=function(){return S.uniq(S.flatten(arguments,!0))},S.intersection=S.intersect=function(e){var t=o.call(arguments,1);return S.filter(S.uniq(e),function(e){return S.every(t,function(t){return S.indexOf(t,e)>=0})})},S.difference=function(e){var t=S.flatten(o.call(arguments,1),!0);return S.filter(e,function(e){return!S.include(t,e)})},S.zip=function(){var e=o.call(arguments),t=S.max(S.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=S.pluck(e,""+r);return n},S.indexOf=function(e,t,n){if(e==null)return-1;var r,i;if(n)return r=S.sortedIndex(e,t),e[r]===t?r:-1;if(g&&e.indexOf===g)return e.indexOf(t);for(r=0,i=e.length;r<i;r++)if(r in e&&e[r]===t)return r;return-1},S.lastIndexOf=function(e,t){if(e==null)return-1;if(y&&e.lastIndexOf===y)return e.lastIndexOf(t);var n=e.length;while(n--)if(n in e&&e[n]===t)return n;return-1},S.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var N=function(){};S.bind=function(t,n){var r,i;if(t.bind===E&&E)return E.apply(t,o.call(arguments,1));if(!S.isFunction(t))throw new TypeError;return i=o.call(arguments,2),r=function(){if(this instanceof r){N.prototype=t.prototype;var e=new N,s=t.apply(e,i.concat(o.call(arguments)));return Object(s)===s?s:e}return t.apply(n,i.concat(o.call(arguments)))}},S.bindAll=function(e){var t=o.call(arguments,1);return t.length==0&&(t=S.functions(e)),x(t,function(t){e[t]=S.bind(e[t],e)}),e},S.memoize=function(e,t){var n={};return t||(t=S.identity),function(){var r=t.apply(this,arguments);return S.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},S.delay=function(e,t){var n=o.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},S.defer=function(e){return S.delay.apply(S,[e,1].concat(o.call(arguments,1)))},S.throttle=function(e,t){var n,r,i,s,o,u,a=S.debounce(function(){o=s=!1},t);return function(){n=this,r=arguments;var f=function(){i=null,o&&e.apply(n,r),a()};return i||(i=setTimeout(f,t)),s?o=!0:u=e.apply(n,r),a(),s=!0,u}},S.debounce=function(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,n||e.apply(i,s)};n&&!r&&e.apply(i,s),clearTimeout(r),r=setTimeout(o,t)}},S.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments))}},S.wrap=function(e,t){return function(){var n=[e].concat(o.call(arguments,0));return t.apply(this,n)}},S.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},S.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},S.keys=w||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)S.has(e,n)&&(t[t.length]=n);return t},S.values=function(e){return S.map(e,S.identity)},S.functions=S.methods=function(e){var t=[];for(var n in e)S.isFunction(e[n])&&t.push(n);return t.sort()},S.extend=function(e){return x(o.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},S.pick=function(e){var t={};return x(S.flatten(o.call(arguments,1)),function(n){n in e&&(t[n]=e[n])}),t},S.defaults=function(e){return x(o.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},S.clone=function(e){return S.isObject(e)?S.isArray(e)?e.slice():S.extend({},e):e},S.tap=function(e,t){return t(e),e},S.isEqual=function(e,t){return C(e,t,[])},S.isEmpty=function(e){if(e==null)return!0;if(S.isArray(e)||S.isString(e))return e.length===0;for(var t in e)if(S.has(e,t))return!1;return!0},S.isElement=function(e){return!!e&&e.nodeType==1},S.isArray=b||function(e){return a.call(e)=="[object Array]"},S.isObject=function(e){return e===Object(e)},S.isArguments=function(e){return a.call(e)=="[object Arguments]"},S.isArguments(arguments)||(S.isArguments=function(e){return!!e&&!!S.has(e,"callee")}),S.isFunction=function(e){return a.call(e)=="[object Function]"},S.isString=function(e){return a.call(e)=="[object String]"},S.isNumber=function(e){return a.call(e)=="[object Number]"},S.isFinite=function(e){return S.isNumber(e)&&isFinite(e)},S.isNaN=function(e){return e!==e},S.isBoolean=function(e){return e===!0||e===!1||a.call(e)=="[object Boolean]"},S.isDate=function(e){return a.call(e)=="[object Date]"},S.isRegExp=function(e){return a.call(e)=="[object RegExp]"},S.isNull=function(e){return e===null},S.isUndefined=function(e){return e===void 0},S.has=function(e,t){return f.call(e,t)},S.noConflict=function(){return e._=t,this},S.identity=function(e){return e},S.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},S.escape=function(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},S.result=function(e,t){if(e==null)return null;var n=e[t];return S.isFunction(n)?n.call(e):n},S.mixin=function(e){x(S.functions(e),function(t){B(t,S[t]=e[t])})};var k=0;S.uniqueId=function(e){var t=k++;return e?e+t:t},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var L=/.^/,A={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(var O in A)A[A[O]]=O;var M=/\\|'|\r|\n|\t|\u2028|\u2029/g,_=/\\(\\|'|r|n|t|u2028|u2029)/g,D=function(e){return e.replace(_,function(e,t){return A[t]})};S.template=function(e,t,n){n=S.defaults(n||{},S.templateSettings);var r="__p+='"+e.replace(M,function(e){return"\\"+A[e]}).replace(n.escape||L,function(e,t){return"'+\n_.escape("+D(t)+")+\n'"}).replace(n.interpolate||L,function(e,t){return"'+\n("+D(t)+")+\n'"}).replace(n.evaluate||L,function(e,t){return"';\n"+D(t)+"\n;__p+='"})+"';\n";n.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+r+"return __p;\n";var i=new Function(n.variable||"obj","_",r);if(t)return i(t,S);var s=function(e){return i.call(this,e,S)};return s.source="function("+(n.variable||"obj")+"){\n"+r+"}",s},S.chain=function(e){return S(e).chain()};var P=function(e){this._wrapped=e};S.prototype=P.prototype;var H=function(e,t){return t?S(e).chain():e},B=function(e,t){P.prototype[e]=function(){var e=o.call(arguments);return u.call(e,this._wrapped),H(t.apply(S,e),this._chain)}};S.mixin(S),x(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];P.prototype[e]=function(){var n=this._wrapped;t.apply(n,arguments);var r=n.length;return(e=="shift"||e=="splice")&&r===0&&delete n[0],H(n,this._chain)}}),x(["concat","join","slice"],function(e){var t=r[e];P.prototype[e]=function(){return H(t.apply(this._wrapped,arguments),this._chain)}}),P.prototype.chain=function(){return this._chain=!0,this},P.prototype.value=function(){return this._wrapped}}).call(this);var Model=function(e,t,n){t=t||{},n=n||{};var r=function(t){this.attributes=jQuery.extend({},t),this.changes={},this.errors=new Model.Errors(this),this.uid=[e,Model.UID.generate()].join("-"),jQuery.isFunction(this.initialize)&&this.initialize()},i=t.persistence;return delete t.persistence,jQuery.extend(r,Model.Callbacks,Model.ClassMethods,t,{_name:e,collection:[],chain:function(e){return jQuery.extend({},this,{collection:e})}}),i&&(r.persistence=i(r)),jQuery.extend(r.prototype,Model.Callbacks,Model.InstanceMethods,n),r};Model.Callbacks={bind:function(e,t){return this.callbacks=this.callbacks||{},this.callbacks[e]=this.callbacks[e]||[],this.callbacks[e].push(t),this},trigger:function(e,t){this.callbacks=this.callbacks||{};var n=this.callbacks[e];if(n)for(var r=0;r<n.length;r++)n[r].apply(this,t||[]);return this},unbind:function(e,t){this.callbacks=this.callbacks||{};if(t){var n=this.callbacks[e]||[];for(var r=0;r<n.length;r++)n[r]===t&&this.callbacks[e].splice(r,1)}else delete this.callbacks[e];return this}},Model.ClassMethods={unique_key:"id",add:function(){var e=[];for(var t=0;t<arguments.length;t++){var n=arguments[t],r=n.id();jQuery.inArray(n,this.collection)===-1&&(!r||!this.find(r))&&(this.collection.push(n),e.push(n))}return e.length>0&&this.trigger("add",e),this},all:function(){return this.collection.slice()},count:function(){return this.collection.length},detect:function(e){var t=this.all(),n;for(var r=0,i=t.length;r<i;r++){n=t[r];if(e.call(n,r))return n}},each:function(e){var t=this.all();for(var n=0,r=t.length;n<r;n++)e.call(t[n],n);return this},find:function(e){return this.detect(function(){return this.id()==e})},first:function(){return this.all()[0]},load:function(e){if(this.persistence){var t=this;this.persistence.read(function(n){for(var r=0,i=n.length;r<i;r++)t.add(n[r]);e&&e.call(t,n)})}return this},last:function(){var e=this.all();return e[e.length-1]},map:function(e){var t=this.all(),n=[];for(var r=0,i=t.length;r<i;r++)n.push(e.call(t[r],t[r],r));return n},pluck:function(e){var t=this.all(),n=[];for(var r=0,i=t.length;r<i;r++)n.push(t[r].attr(e));return n},remove:function(e){var t;for(var n=0,r=this.collection.length;n<r;n++)if(this.collection[n]===e){t=n;break}return t!=undefined?(this.collection.splice(t,1),this.trigger("remove",[e]),!0):!1},reverse:function(){return this.chain(this.all().reverse())},select:function(e){var t=this.all(),n=[],r;for(var i=0,s=t.length;i<s;i++)r=t[i],e.call(r,i)&&n.push(r);return this.chain(n)},sort:function(e){var t=this.all().slice().sort(e);return this.chain(t)},sortBy:function(e){var t=jQuery.isFunction(e),n=function(t){return e.call(t)};return this.sort(function(r,i){var s=t?n(r):r.attr(e),o=t?n(i):i.attr(e);return s<o?-1:s>o?1:0})}},Model.Errors=function(e){this.errors={},this.model=e},Model.Errors.prototype={add:function(e,t){return this.errors[e]||(this.errors[e]=[]),this.errors[e].push(t),this},all:function(){return this.errors},clear:function(){return this.errors={},this},each:function(e){for(var t in this.errors)for(var n=0;n<this.errors[t].length;n++)e.call(this,t,this.errors[t][n]);return this},on:function(e){return this.errors[e]||[]},size:function(){var e=0;return this.each(function(){e++}),e}},Model.InstanceMethods={attr:function(e,t){if(arguments.length===0)return jQuery.extend({},this.attributes,this.changes);if(arguments.length===2)return this.attributes[e]===t?delete this.changes[e]:this.changes[e]=t,this;if(typeof e=="object"){for(var n in e)this.attr(n,e[n]);return this}return e in this.changes?this.changes[e]:this.attributes[e]},callPersistMethod:function(e,t){var n=this,r=function(){e==="create"?n.constructor.add(n):e==="destroy"&&n.constructor.remove(n)},i=function(i){i&&(n.merge(n.changes).reset(),r(),n.trigger(e));var s;return t&&(s=t.apply(n,arguments)),s};this.constructor.persistence?this.constructor.persistence[e](this,i):i.call(this,!0)},destroy:function(e){return this.callPersistMethod("destroy",e),this},id:function(){return this.attributes[this.constructor.unique_key]},merge:function(e){return jQuery.extend(this.attributes,e),this},newRecord:function(){return this.id()===undefined},reset:function(){return this.errors.clear(),this.changes={},this},save:function(e){if(this.valid()){var t=this.newRecord()?"create":"update";this.callPersistMethod(t,e)}else e&&e(!1);return this},valid:function(){return this.errors.clear(),this.validate(),this.errors.size()===0},validate:function(){return this}},Model.localStorage=function(){return window.localStorage?function(e){var t=[e._name,"collection"].join("-"),n=function(){var e=localStorage[t];return e?JSON.parse(e):[]},r=function(e){localStorage.setItem(t,JSON.stringify(e))},i=function(e){var t=n();jQuery.inArray(e,t)===-1&&(t.push(e),r(t))},s=function(e){var t=n(),i=jQuery.inArray(e,t);i>-1&&(t.splice(i,1),r(t))},o=function(e){var t=e.uid,n=JSON.stringify(e.attr());localStorage.setItem(t,n),i(t)};return{create:function(e,t){o(e),t(!0)},destroy:function(e,t){localStorage.removeItem(e.uid),s(e.uid),t(!0)},read:function(t){if(!t)return!1;var r=e.map(function(){return this.uid}),i=n(),s=[],o,u,a;for(var f=0,l=i.length;f<l;f++)a=i[f],jQuery.inArray(a,r)==-1&&(o=JSON.parse(localStorage[a]),u=new e(o),u.uid=a,s.push(u));t(s)},update:function(e,t){o(e),t(!0)}}}:function(){return{create:function(e,t){t(!0)},destroy:function(e,t){t(!0)},read:function(e){e([])},update:function(e,t){t(!0)}}}},Model.Log=function(){window.console&&window.console.log.apply(window.console,arguments)},Model.REST=function(e,t){var n=/:(\w+)/g,r=function(){var t=[],r;while((r=n.exec(e))!==null)t.push(r[1]);return t}(),i=jQuery.extend({path:function(t){var n=e;return $.each(r,function(e,r){n=n.replace(":"+r,t.attributes[r]||t[r]&&t[r]()||":"+r)}),n},create:function(e,t){return this.xhr("POST",this.create_path(e),e,t)},create_path:function(e){return this.path(e)},destroy:function(e,t){return this.xhr("DELETE",this.destroy_path(e),e,t)},destroy_path:function(e){return this.update_path(e)},params:function(e){var t;if(e){var n=e.attr();delete n[e.constructor.unique_key],e.constructor.attrs_accessible!=null&&$.each(Object.keys(n),function(t,r){$.inArray(r,e.constructor.attrs_accessible)==-1&&delete n[r]}),t={},t[e.constructor._name.toLowerCase()]=n}else t=null;return jQuery.ajaxSettings.data&&(t=jQuery.extend({},jQuery.ajaxSettings.data,t)),JSON.stringify(t)},read:function(e){var t=this.klass;return this.xhr("GET",this.read_path(),null,function(n,r,i){i=jQuery.makeArray(i);var s=[];for(var o=0,u=i.length;o<u;o++)s.push(new t(i[o]));e(s)})},read_path:function(){return e},update:function(e,t){return this.xhr("PUT",this.update_path(e),e,t)},update_path:function(e){return[this.path(e),e.id()].join("/")},xhr:function(e,t,n,r){var i=this,s=e=="GET"?undefined:this.params(n);return/.json$/.test(t)||(t+=".json"),jQuery.ajax({type:e,url:t,contentType:"application/json",dataType:"json",data:s,dataFilter:function(e,t){return/\S/.test(e)?e:undefined},complete:function(e,t){i.xhrComplete(e,t,n,r)}})},xhrComplete:function(e,t,n,r){var i=Model.REST["handle"+e.status];i&&i.call(this,e,t,n);var s=t==="success",o=Model.REST.parseResponseData(e);s&&n&&o&&n.attr(o),r&&r.call(n,s,e,o)}},t);return function(e){return i.klass=e,i}},Model.RestPersistence=Model.REST,Model.REST.handle422=function(e,t,n){var r=Model.REST.parseResponseData(e);if(r){n.errors.clear();for(var i in r)for(var s=0;s<r[i].length;s++)n.errors.add(i,r[i][s])}},Model.REST.parseResponseData=function(e){try{return/\S/.test(e.responseText)?jQuery.parseJSON(e.responseText):undefined}catch(t){Model.Log(t)}},Model.UID={counter:0,generate:function(){return[(new Date).valueOf(),this.counter++].join("-")},reset:function(){return this.counter=0,this}},Model.VERSION="0.9.4",function(){var e,t,n;e=jQuery,t=function(e,t){var r,i,s,o,u,a,f;s=t.match(/{{([^{]+)}}/g);if(!s)return n(e,t);o=new String(t);for(a=0,f=s.length;a<f;a++)i=s[a],r=i.match(/{{(.+)}}/)[1],u=n(e,r),o=o.replace(i,u);return o},n=function(e,t){var n,r,i,s;i=null;if(t==="self")return e;s=t.split(/\./),n=s.shift(),e[n]!=null?typeof e[n]=="function"?i=e[n]():i=e[n]:typeof window[n]=="function"?i=window[n]():i=window[n];while(i&&(r=s.shift()))typeof i[r]=="function"?i=i[r]():i=i[r];return i},jQuery.fn.downP=function(){var t;t=this[0]&&this[0].firstChild;while(t&&t.nodeType!==1)t=t.nextSibling;return e(t)},jQuery.fn.jlt=function(n){var r,i;return i=e.isArray(n)?n:[n||{}],r=jQuery("<div/>"),this.each(function(){var n,s,o,u,a,f,l,c,h,p,d,v,m,g,y;o=e(this),y=[];for(l=0,p=i.length;l<p;l++){f=i[l],n=o.clone();while((s=n.find("[jif],[jnif],[jeach]").first())[0]){if(s.attr("jif")){if(!t(f,s.attr("jif"))){s.remove();continue}s.removeAttr("jif")}if(s.attr("jnif")){if(t(f,s.attr("jnif"))){s.remove();continue}s.removeAttr("jnif")}s.attr("jeach")&&(a=s.attr("jeach"),s.removeAttr("jeach"),s.replaceWith(s.jlt(t(f,a))))}n.find("[jtext]").each(function(){return s=e(this),s.text(t(f,s.attr("jtext")))}).removeAttr("jtext"),n.find("[jhtml]").each(function(){return s=e(this),s.append(t(f,s.attr("jhtml")))}).removeAttr("jhtml"),m=["jid","jhref","jaction","jsrc"];for(c=0,d=m.length;c<d;c++)u=m[c],n.find("["+u+"]").each(function(){return s=e(this),s.attr(u.replace("j",""),t(f,s.attr(u)))}).removeAttr(u);n.find("[jclass]").each(function(){return s=e(this),s.addClass(t(f,s.attr("jclass")))}).removeAttr("jclass"),n.find("[jclass2]").each(function(){return s=e(this),s.addClass(t(f,s.attr("jclass2")))}).removeAttr("jclass2"),n.find("[jdata]").each(function(){return s=e(this),s.data(s.attr("jdata"),t(f,s.attr("jdata")))}).removeAttr("jdata"),g=["jattr","jattr2","jattr3"];for(h=0,v=g.length;h<v;h++)u=g[h],n.find("["+u+"]").each(function(){var n,r;return s=e(this),r=s.attr(u).split(/\./),n=r.shift(),s.attr(n,t(f,r.join(".")))}).removeAttr(u);n.find("[jattrif]").each(function(){var n,r,i;s=e(this),i=s.attr("jattrif").split(/\./),n=i.shift(),r=i.shift();if(r===t(f,i.join(".")))return s.attr(n,n)}).removeAttr("jattrif"),n.find("[jval]").each(function(){return s=e(this),s.val(t(f,s.attr("jval")))}).removeAttr("jval"),y.push(r.append(n.children()))}return y}),r.children()},window.tc={},e(document).ready(function(){return e("#templates").children().each(function(){var t;return t=e(this),tc[t.attr("id")]=t}),e("#templates").remove()})}.call(this),function(){var e,t,n,r,i,s;e=jQuery,i={8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del"},s=[];for(t in i)n=i[t],s[n]=t;r={init:function(t,r){return this.each(function(){var o,u,a,f,l,c,h,p;o=e(this),a=[],f=[];for(l=0,c=t.length;l<c;l++)u=t[l],n=_(u.split("+")).last(),s[n]!=null?f.push(n):a.push(n);return h=_(a),p=_(f),o.bind("keypress",function(e){var t,n;t=e.keyCode||e.which,n=String.fromCharCode(t);if(h.include(n))return r.call(this,n,e)}),o.bind("keydown",function(e){var t,n;t=e.keyCode||e.which,n=i[t];if(p.include(n))return e.shiftKey&&(n="shift+"+n),r.call(this,n,e)})})},remove:function(){return this.each(function(){var t;return t=e(this),console.log("not implemented")})}},e.fn.bkeys=function(t){return r[t]!=null?r[t].apply(this,Array.prototype.slice.call(arguments,1)):typeof t=="object"||!t?r.init.apply(this,arguments):e.error("Method "+t+" does not exist on jQuery.bkeys")}}.call(this),function(){var e,t,n;e=jQuery,t=e(window),n={init:function(n){return n==null&&(n={}),this.each(function(){var n,r,i,s,o,u;n=e(this),r=n.offset(),o=void 0,u=void 0,s=t.scrollTop(),i=t.scrollLeft(),r.left<i?o=r.left-20<0?0:r.left-20:r.left+n.outerWidth()>i+t.width()+1&&(o=r.left-20),r.top-30<s?u=r.top-30:r.top+n.outerHeight()+40>s+t.height()&&(u=40+r.top+n.outerHeight()-t.height());if(o!=null||u!=null)return o==null&&(o=0),u==null&&(u=0),scrollTo(o,u)})}},e.fn.jscrollTo=function(t){return n[t]!=null?n[t].apply(this,Array.prototype.slice.call(arguments,1)):typeof t=="object"||!t?n.init.apply(this,arguments):e.error("Method "+t+" does not exist on jQuery.jscrollTo")}}.call(this),function(){var e,t;e=jQuery,t=Model("manual"),t.persistence=Model.REST("/admin_public/documents")(t),t.prototype.items=function(){var e;return e=this.id(),Item.select(function(){return this.attr("document_id")===e})},t.prototype.sortedItems=function(){return this.items().sortBy("position")},t.prototype.updateTOC=function(){return e("#toc").replaceWith(tc.toc_jlt.jlt(this))},window.Manual=t,window.Item=Model("item",{},{chapter_i:function(){var e;return e=this.position(),this.manual().items().select(function(){return this.position()<=e&&this.format()==="chapter"}).count()},section_i:function(){var e,t;return e=this.chapter_i(),t=this.position(),this.manual().items().select(function(){return this.position()<=t&&this.format()==="section"&&this.chapter_i()===e}).count()},position:function(){return parseInt(this.attr("position"),10)},is_chapter:function(){return this.attr("format")==="chapter"},is_section:function(){return this.attr("format")==="section"},is_pro_tip:function(){return this.attr("format")==="pro_tip"},body:function(){return this.attr("body")},formatted_body:function(){return this.attr("formatted_body")},title:function(){return this.attr("title")},format:function(){return this.attr("format")},has_photo:function(){return this.attr("has_photo")},photo_id:function(){return this.attr("photo_id")},manual:function(){return t.find(this.attr("document_id"))},item:function(){return this},next:function(){var e;return e=this.position()+1,this.manual().items().detect(function(){return this.position()===e})},prev:function(){var e;return e=this.position()-1,this.manual().items().detect(function(){return this.position()===e})},show:function(){var t;return this.$item||(this.$item=e("#item_"+this.id())),t=tc.item_jlt.jlt(this),this.$item.length?this.$item.replaceWith(t):e("#items").append(t),this.$item=t},renumber:function(){return this.$item.find("span.chapter_number").text(this.chapter_i()),this.$item.find("span.section_number").text(this.section_i())},edit:function(){var t;return t=tc.new_item_jlt.jlt(this),this.$item||(this.$item=e("#item_"+this.id())),this.$item.replaceWith(t),t.find("#format").trigger("change"),t.find("textarea").expandable(),t.jscrollTo().effect("highlight",{},3e3).find(":input:visible:first").trigger("focus"),this.$item=t},"delete":function(){if(confirm("Are you sure you want to delete it?"))return this.destroy(function(t){return t?(e.gritter.add({title:"Item Deleted",text:" has been deleted."}),this.$item||(this.$item=e("#item_"+this.id())),this.$item.effect("highlight",{color:"#FF0000"},500).hide("blind",500,function(){return e(this).remove()}),window.renumber()):e.gritter.add({title:"Error!",text:"Uh Oh! Item Deletion Problem. Please try reloading this page.",sticky:!0})})},formAttrs:function(e){var t,n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.attr(t.name,t.value));return i},selectOptions:function(){var e,t,n,r,i,s;e=["chapter","section","text","pro_tip"],r="",t=this.format()||"text";for(i=0,s=e.length;i<s;i++)n=e[i],r+=t===n?"<option value='"+n+"' selected='selected'>"+n+"</option>":"<option value='"+n+"'>"+n+"</option>";return r}}),Item.persistence=Model.REST("/admin_public/documents/:document_id/items")(Item),window.Item=Item,e("document").ready(function(){var e,n,r,i,s,o,u,a,f,l,c;if(R.items){f=R.items;for(s=0,u=f.length;s<u;s++)e=f[s],n=new Item(e),Item.add(n)}if(R.manuals){l=R.manuals,c=[];for(o=0,a=l.length;o<a;o++)i=l[o],r=new t(i),c.push(t.add(r));return c}})}.call(this),function(){var e,t,n;e=jQuery,e.fn.move_up=function(){var e,t,n;return this.hasClass("chapter")?(t=this.nextUntil("div.chapter").andSelf(),e=this.prevAll("div.chapter").first(),e.length===1&&e.before(t)):this.hasClass("section")?(n=this.nextUntil("div.chapter, div.section").andSelf(),e=this.prevAll("div.chapter, div.section").first(),e.length===1&&e.before(n)):(e=this.prev(),e.length===1&&e.before(this)),this},e.fn.move_down=function(){var t,n,r,i;return this.hasClass("chapter")?(r=this.nextUntil("div.chapter").andSelf(),n=this.nextAll("div.chapter").eq(1),n.length===1?n.before(r):e("div.document").append(r)):this.hasClass("section")?(i=this.nextUntil("div.chapter, div.section").andSelf(),n=this.nextAll("div.chapter, div.section").eq(1),n.length===1?n.before(i):e("div.document").append(i)):(t=this.next(),t.length===1&&t.after(this)),this},t=function(){var t,n,r;return r=Item.sortBy("position").map(function(){return this.id()}),t=e("div.document"),n=t.attr("id").replace("document_",""),e.ajax({type:"PUT",url:"/admin_public/documents/"+n+"/items/order",data:{items:r}})},n=function(){return Manual.first().updateTOC()},window.renumber=function(){var t,n;return n=0,t=0,e("div.document").find("div.item").each(function(t,n){var r;return r=e(n).data("item"),r.attributes.position=t+1}),Item.each(function(){if(this.format()==="chapter"||this.format()==="section")return this.renumber()})},e("button.up").live("click",function(r){var i;return i=e(this).closest("div.nav"),i.move_up().jscrollTo(),renumber(),t(),n()}),e("button.down").live("click",function(r){var i;return i=e(this).closest("div.nav"),i.move_down().jscrollTo(),renumber(),t(),n()})}.call(this),function(){var e;e=jQuery,e("#format").live("change",function(t){var n,r,i;i=e(this),n=i.closest("form"),r=n.closest("div.item"),r.removeClass("chapter section pro_tip text"),r.addClass(i.val());switch(i.val()){case"chapter":case"section":return n.find("li.title").show(),n.find("li.body").hide(),n.find("li.photo_fields").hide();case"pro_tip":return n.find("li.title").show(),n.find("li.body").show(),n.find("li.photo_fields").hide();default:return n.find("li.title").hide(),n.find("li.body").show(),n.find("li.photo_fields").show()}})}.call(this),function(){var e,t;e=jQuery,e("a.cancel_new").live("click",function(t){return e(this).parent().hide("blind",600,function(){return e(this).remove()})}),t=function(){return e("script:not(.keep)").remove(),e("div.controls").remove(),e("div.selected").removeClass("selected"),e("div.header").remove(),e("div.state_box").remove(),e("div.templates").remove(),e("meta[name=csrf-param]").remove(),e("meta[name=csrf-token]").remove(),e("iframe").remove()},e(document).ready(function(){var n,r,i,s,o;if(R.manual_id){r=Manual.find(R.manual_id),r.updateTOC(),o=r.sortedItems().all();for(i=0,s=o.length;i<s;i++)n=o[i],n.show()}return e("button.download").bind("click",t)})}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,D,P,H,B,j,F,I,q,U,z,W,X,V,$,J=this;e=window.jQuery,i=e(window),f=null,n=null,t=null,F={},H=function(e,t){var r;n&&!n.is(":visible")&&T("start");if(((r=f.events_by_trigger)!=null?r[e]:void 0)==null)return;if(t.target&&(/textarea|select/i.test(t.target.nodeName)||/text|password|search|tel|url|email|number/i.test(t.target.type)))return;return t.preventDefault(),doc_triggerEvent(f.events_by_trigger[e].name,e)},window.doc_triggerEvent=function(t,n){return n==null&&(n=""),r.find("div.event").remove(),e("<div class='event'><i>"+t+"</i></div>").appendTo(r).effect("highlight",{color:"#00FF00"},1500),setTimeout(function(){var e,r;e=(r=f.events_by_name[t])!=null?r:console.log(""+t+" is not valid for state "+f.name);if(e.return_state)return T(e.return_state.call(this,n));if(!e.callback)return T(e.transitions[f.name]);if(e.callback.call(this,n))return T(e.transitions[f.name])},50)},d=function(){return n.removeClass("selected"),n=null,!0},k=function(){return n.removeClass("selected"),n=L(n),n.jscrollTo().addClass("selected")},D=function(){return n.removeClass("selected"),n=P(n),n.jscrollTo().addClass("selected")},a=function(){return n.hasClass("chapter")?n.nextUntil("div.chapter").hide():n.hasClass("section")&&n.nextUntil("div.section, div.chapter").hide(),n.addClass("collapsed")},m=function(){return n.hasClass("chapter")?n.nextUntil("div.chapter").show():n.hasClass("section")&&n.nextUntil("div.section, div.chapter").show(),n.removeClass("collapsed")},E=function(e){if(f.name==="edit")return;if(n&&e[0]===n[0])return;return n!=null&&n.removeClass
("selected"),n=e,T("navigation"),n.jscrollTo().addClass("selected")},B=function(e){return n!=null&&n.removeClass("selected"),n=e.$item,n.jscrollTo().addClass("selected")},p=function(e){var t;n!=null&&n.removeClass("selected");if(!e.newRecord())return e.show(),n=e.$item,n.jscrollTo().addClass("selected");e.$item.remove();if(t=e.prev()||e.next()||e.manual().items().first())return n=t.$item,n.jscrollTo().addClass("selected")},w=function(){return n!=null&&n.removeClass("selected"),n=g(),n.jscrollTo().addClass("selected")},O=function(){var t;return n.removeClass("selected"),t=n.attr("id"),n.find("button.edit").trigger("click"),setTimeout(function(){return n=e("#"+t),n.jscrollTo().addClass("selected")},800)},l=function(){var e,t;return n.removeClass("selected"),t=n,e=L(n),t.attr("id")===e.attr("id")&&(e=g()),t.find("button.delete").trigger("click"),n=e,n.jscrollTo().addClass("selected")},S=function(e){return n.find("button."+e).trigger("click").effect("highlight",{color:"#00ff00"},100)},N=function(){return S("up")},x=function(){return S("down")},A=function(){var e;return n.removeClass("selected"),e=n.find("button.add:first"),e.length!==1?!1:(e.trigger("click"),setTimeout(function(){return n=n.next(),n.jscrollTo().addClass("selected")},800))},M=function(){var n,r,i;return t!=null&&t.remove(),n=function(){var e,t;e=f.events_by_name,t=[];for(i in e)r=e[i],t.push(r);return t}(),t=tc.help_jlt.jlt({current_state_name:f.name,events:n}),e("body").append(t)},u=function(){var e;return e=t.data("current_state_name"),t.remove(),e},L=function(t){var n,r,i;return n=e("div.nav:visible"),i=n.index(t),r=n.eq(i+1),r.length===1?r:t},P=function(t){var n,r;return n=e("div.nav:visible"),r=n.index(t),r===0?t:n.eq(r-1)},g=function(){var t,n,r,s,o;o=e("div.nav:visible").toArray();for(r=0,s=o.length;r<s;r++){n=o[r],t=e(n);if(t.offset().top>i.scrollTop())return t}return e("div.nav:first")},j={start:"Keyboard Navigation",navigation:"Naviation",edit:"Editing",help:"Help"},v={esc_to_start:{transitions:{navigation:"start"},triggers:["esc"],help:"End keyboard naviation",callback:d},start_nav:{transitions:{start:"navigation"},triggers:["j","k","down","up"],help:"Select First row",callback:w},to_next:{transitions:{navigation:"navigation"},triggers:["j","down"],help:"Next Down",callback:k},to_prev:{transitions:{navigation:"navigation"},triggers:["k","up"],help:"Previous Up",callback:D},start_edit:{transitions:{navigation:"edit"},triggers:["e"],help:"<b>e</b>dit selection",callback:O},delete_item:{transitions:{navigation:"navigation"},triggers:["d"],help:"<b>d</b>elete selection",callback:l},start_add:{transitions:{navigation:"edit"},triggers:["a"],help:"<b>a</b>dd sub section",callback:A},saved:{transitions:{edit:"navigation"},callback:B},edit_cancelled:{transitions:{edit:"navigation"},callback:p},move_up:{transitions:{navigation:"navigation"},triggers:["h"],help:"move <b>h</b>igher",callback:N},move_down:{transitions:{navigation:"navigation"},triggers:["l"],help:"move <b>l</b>ower",callback:x},collapse:{transitions:{navigation:"navigation"},triggers:["c"],help:"<b>c</b>collapse section or chapter",callback:a},expand:{transitions:{navigation:"navigation"},triggers:["o","x"],help:"e<b>x</b>pand <b>o</b>pen collapsed section or chapter",callback:m},ask_help:{transitions:{navigation:"help",start:"help",edit:"help"},triggers:["?"],help:"get keyboard help <b>?</b>",callback:M},esc_from_help:{transitions:{help:["navigation","start","edit"]},triggers:["esc"],help:"close help",return_state:u}},s=[];for(C in j)b=j[C],F[C]={},F[C].name=C,F[C].full_name=b;for(h in v){c=v[h],c.name=h,c.triggers!=null&&(s=s.concat(c.triggers)),V=c.transitions;for(y in V){I=V[y],(U=F[y]).events_by_trigger||(U.events_by_trigger={}),(z=F[y]).events_by_name||(z.events_by_name={}),F[y].events_by_name[h]=c;if(c.triggers!=null){$=c.triggers;for(W=0,X=$.length;W<X;W++)q=$[W],F[y].events_by_trigger[q]=c}}}s=_(s).uniq(),o=s.join(", "),r=e('<div class="doc_state_box"/>'),T=function(t){return r.find("div.state").effect("highlight",{color:"#FF0000"},2e3).hide("blind",500,function(){return e(this).remove()}),e("<div class='state'>"+t+"</div>").appendTo(r).effect("highlight",{color:"#00FF00"},1500),f=F[t]||console.log("state_name "+t+" not found!")},n=null,e(document).ready(function(){if(R.manual_id!=null)return r.appendTo("body"),T("start"),e(window).bkeys(s,H)}),e("div.nav").live("mousemove",function(t){return E(e(this)),!1}),e("div.nav").live("touchstart",function(t){var n;return n=e(this),n.hasClass("selected")?!0:(E(n),!1)}),e("button.expand_c").live("click",function(e){return doc_triggerEvent("expand")}),e("button.collapse_c").live("click",function(e){return doc_triggerEvent("collapse")}),e("button.add").live("click",function(t){var n,r,i,s;return n=e(this).closest("div.item"),i=n.data("item"),s=new Item({document_id:R.manual_id,position:parseInt(i.position(),10)+1}),r=tc.new_item_jlt.jlt(s),s.$item=r,n.length===1?n.after(r):e("div.document").append(r),r.jscrollTo().effect("highlight",{},3e3).find(":input:visible:first").trigger("focus"),e("#format").trigger("change"),r.find("textarea").expandable()}),e("button.edit").live("click",function(t){return e(this).closest("div.item").data("item").edit()}),e("form.control").live("submit",function(t){var n,r,i;return n=e(this),i=n.closest("div.item").data("item"),i.formAttrs(n.serializeArray()),r=i.newRecord()?"created":"updated",i.save(function(t){return t?(e.gritter.add({title:"Item "+r,text:"has been "+r+"."}),i.show(),renumber(),doc_triggerEvent("saved",i),i.$item.jscrollTo().effect("highlight",{},3e3)):(e.gritter.add({title:"Manual Error",text:"Item not updated."}),i.edit())}),t.preventDefault(),!1}),e("button.delete").live("click",function(t){return e(this).closest("div.item").data("item")["delete"]()}),e("button.cancel").live("click",function(t){var n;return n=e(this).closest("div.item").data("item"),doc_triggerEvent("edit_cancelled",n),t.preventDefault()})}.call(this);